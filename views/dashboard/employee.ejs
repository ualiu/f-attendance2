<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - Felton Brushes</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <%- include('../partials/header') %>
  <%- include('../partials/sidebar') %>

  <main class="main-with-sidebar">
    <div class="employee-header">
      <div>
        <h1><%= employee.name %></h1>
        <p class="employee-meta">
          <%= employee.employee_id %> | <%= employee.shift %>
        </p>
      </div>
    </div>

    <!-- Employee Details -->
    <div class="section">
      <h2>Employee Information</h2>
      <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
          <div>
            <strong>Employee ID:</strong><br>
            <%= employee.employee_id %>
          </div>
          <div>
            <strong>Shift:</strong><br>
            <%= employee.shift %>
          </div>
          <div>
            <strong>Phone:</strong><br>
            <%= employee.phone %>
          </div>
          <div>
            <strong>Start Date:</strong><br>
            <%= employee.start_date ? new Date(employee.start_date).toLocaleDateString() : 'Not set' %>
          </div>
        </div>
      </div>
    </div>

    <!-- Manual Absence Logging -->
    <div class="section">
      <h2>Log Manual Absence</h2>
      <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <form id="manualAbsenceForm" style="display: grid; gap: 1rem;">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
            <div class="form-group">
              <label for="absenceType"><strong>Incident Type *</strong></label>
              <select id="absenceType" name="type" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">Select incident type...</option>
                <option value="no_sms_no_show">No SMS, No Show</option>
                <option value="late_sms_no_show">Late SMS, No Show</option>
                <option value="left_early_no_permission">Left Early, No Permission</option>
                <option value="left_early_permission">Left Early with Permission</option>
                <option value="late_in_no_sms">Late In, No SMS</option>
              </select>
            </div>

            <div class="form-group">
              <label for="absenceDate"><strong>Date *</strong></label>
              <input type="date" id="absenceDate" name="date" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" value="<%= new Date().toISOString().split('T')[0] %>">
            </div>
          </div>

          <div class="form-group">
            <label for="absenceReason"><strong>Reason/Notes *</strong></label>
            <textarea id="absenceReason" name="reason" required rows="3" placeholder="Enter reason or additional notes..." style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-family: inherit;"></textarea>
          </div>

          <div>
            <button type="submit" class="btn btn-primary">Log Absence</button>
            <button type="reset" class="btn btn-secondary">Clear Form</button>
          </div>

          <div id="formMessage" style="display: none; padding: 1rem; border-radius: 4px; margin-top: 0.5rem;"></div>
        </form>
      </div>
    </div>

    <div class="section">
      <div class="section-header">
        <h2>Absence History (This Quarter)</h2>
        <small style="color: #666;">Starting <%= quarterStart.toLocaleDateString() %></small>
      </div>

      <div class="table-responsive">
        <table class="data-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Reason</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if (absences.length === 0) { %>
            <tr>
              <td colspan="4" class="no-data">No absences this quarter</td>
            </tr>
          <% } else { %>
            <% absences.forEach(absence => { %>
              <tr>
                <td><%= new Date(absence.date).toLocaleDateString() %></td>
                <td><span class="type-badge type-<%= absence.type %>"><%= absence.type %></span></td>
                <td><%= absence.reason %></td>
                <td>
                  <% if (absence.report_message) { %>
                    <button onclick="viewMessage('<%= absence._id %>')" class="btn-small">View</button>
                  <% } %>
                </td>
              </tr>
            <% }); %>
          <% } %>
        </tbody>
      </table>
      </div>
    </div>

    <div class="quick-actions">
      <a href="/reports/employee?employeeId=<%= employee._id %>" class="btn btn-primary">Generate AI Report</a>
      <a href="/dashboard" class="btn btn-secondary">Back to Dashboard</a>
    </div>
  </main>

  <script src="/js/dashboard.js"></script>
  <script src="/js/global.js"></script>
  <script>
    // Toggle sidebar for mobile
    function toggleSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    // Close sidebar when clicking on a link (mobile only)
    document.querySelectorAll('.sidebar-link').forEach(link => {
      link.addEventListener('click', () => {
        if (window.innerWidth < 768) {
          toggleSidebar();
        }
      });
    });

    // Manual absence form submission
    document.getElementById('manualAbsenceForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = {
        employee_id: '<%= employee._id %>',
        type: document.getElementById('absenceType').value,
        date: document.getElementById('absenceDate').value,
        reason: document.getElementById('absenceReason').value
      };

      const messageDiv = document.getElementById('formMessage');
      const submitBtn = e.target.querySelector('button[type="submit"]');

      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.textContent = 'Logging...';

      try {
        const response = await fetch('/api/absences', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        const data = await response.json();

        if (data.success) {
          messageDiv.style.display = 'block';
          messageDiv.style.background = '#d4edda';
          messageDiv.style.color = '#155724';
          messageDiv.style.border = '1px solid #c3e6cb';
          messageDiv.textContent = '✅ Absence logged successfully!';

          // Reset form
          e.target.reset();
          document.getElementById('absenceDate').value = '<%= new Date().toISOString().split('T')[0] %>';

          // Reload page after 1 second to show new absence in table
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } else {
          throw new Error(data.error || 'Failed to log absence');
        }
      } catch (error) {
        messageDiv.style.display = 'block';
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.color = '#721c24';
        messageDiv.style.border = '1px solid #f5c6cb';
        messageDiv.textContent = '❌ Error: ' + error.message;

        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.textContent = 'Log Absence';
      }
    });

    // Format absence type badges on page load
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.type-badge').forEach(badge => {
        const rawType = badge.textContent.trim();
        badge.textContent = formatAbsenceType(rawType);
      });
    });
  </script>
</body>
</html>
