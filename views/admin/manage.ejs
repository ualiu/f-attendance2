<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage System - Felton Brushes</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <%- include('../partials/header') %>
  <%- include('../partials/sidebar') %>

  <main class="main-with-sidebar">
    <h1>Employee Management</h1>
    <div id="employees-section">
      <div class="section-header">
        <button onclick="showAddEmployeeModal()" class="btn btn-primary">+ Add Employee</button>
      </div>

      <div class="search-bar">
        <input type="text" id="employeeSearch" placeholder="Search employees..." onkeyup="searchEmployees()">
      </div>

      <div class="table-responsive">
        <table class="data-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Employee ID</th>
            <th>Shift</th>
          </tr>
        </thead>
        <tbody id="employeeTableBody">
          <% if (employees.length === 0) { %>
            <tr>
              <td colspan="3" class="no-data">No employees yet. Add your first employee above.</td>
            </tr>
          <% } else { %>
            <% employees.forEach(emp => { %>
              <tr>
                <td><a href="/dashboard/employee/<%= emp._id %>"><%= emp.name %></a></td>
                <td><%= emp.employee_id %></td>
                <td><%= emp.shift %></td>
              </tr>
            <% }); %>
          <% } %>
        </tbody>
      </table>
      </div>
    </div>

  <!-- Add Employee Modal -->
  <div id="addEmployeeModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2>Add Employee</h2>
      <form id="addEmployeeForm" onsubmit="addEmployee(event)">
        <div class="form-group">
          <label>Name</label>
          <input type="text" name="name" required>
        </div>
        <div class="form-group">
          <label>Employee ID</label>
          <input type="text" name="employee_id" required>
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" name="phone" required>
        </div>
        <div class="form-group">
          <label>Shift</label>
          <select name="shift" required>
            <option value="Day">Day</option>
            <option value="Night">Night</option>
            <option value="Weekend">Weekend</option>
          </select>
        </div>
        <div class="form-group">
          <label>Start Date</label>
          <input type="date" name="start_date">
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn btn-primary">Add Employee</button>
          <button type="button" onclick="closeModal('addEmployeeModal')" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Employee Modal -->
  <div id="editEmployeeModal" class="modal" style="display: none;">
    <div class="modal-content">
      <h2>Edit Employee</h2>
      <form id="editEmployeeForm" onsubmit="updateEmployee(event)">
        <input type="hidden" name="employee_id" id="edit_employee_id">

        <div class="form-group">
          <label>Name</label>
          <input type="text" name="name" id="edit_name" required>
        </div>
        <div class="form-group">
          <label>Employee ID</label>
          <input type="text" id="edit_employee_code" disabled>
        </div>
        <div class="form-group">
          <label>Phone</label>
          <input type="tel" name="phone" id="edit_phone" required>
        </div>
        <div class="form-group">
          <label>Shift</label>
          <select name="shift" id="edit_shift" required>
            <option value="Day">Day</option>
            <option value="Night">Night</option>
            <option value="Weekend">Weekend</option>
          </select>
        </div>
        <div class="form-group">
          <label>Start Date</label>
          <input type="date" name="start_date" id="edit_start_date">
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn btn-primary">Update Employee</button>
          <button type="button" onclick="closeModal('editEmployeeModal')" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Toggle sidebar for mobile
    function toggleSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.querySelector('.sidebar-overlay');
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
    }

    // Close sidebar when clicking on a link (mobile only)
    document.querySelectorAll('.sidebar-link').forEach(link => {
      link.addEventListener('click', () => {
        if (window.innerWidth < 768) {
          toggleSidebar();
        }
      });
    });

    function showTab(tab) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(tab + '-tab').classList.add('active');
      event.target.classList.add('active');
    }

    function showAddEmployeeModal() {
      document.getElementById('addEmployeeModal').style.display = 'flex';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    async function addEmployee(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);

      const response = await fetch('/api/employees', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        location.reload();
      } else {
        alert('Error adding employee');
      }
    }

    async function deleteEmployee(id) {
      if (!confirm('Are you sure you want to delete this employee?')) return;

      const response = await fetch(`/api/employees/${id}`, { method: 'DELETE' });
      if (response.ok) {
        location.reload();
      } else {
        alert('Error deleting employee');
      }
    }

    async function editEmployee(id) {
      // Fetch employee data
      const response = await fetch(`/api/employees/${id}`);
      if (!response.ok) {
        alert('Error loading employee data');
        return;
      }

      const { employee } = await response.json();

      // Populate form
      document.getElementById('edit_employee_id').value = employee._id;
      document.getElementById('edit_name').value = employee.name;
      document.getElementById('edit_employee_code').value = employee.employee_id;
      document.getElementById('edit_phone').value = employee.phone;
      document.getElementById('edit_shift').value = employee.shift;
      document.getElementById('edit_start_date').value = employee.start_date ? new Date(employee.start_date).toISOString().split('T')[0] : '';

      // Show modal
      document.getElementById('editEmployeeModal').style.display = 'flex';
    }

    async function updateEmployee(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      const employeeId = data.employee_id;
      delete data.employee_id;

      const response = await fetch(`/api/employees/${employeeId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        closeModal('editEmployeeModal');
        location.reload();
      } else {
        alert('Error updating employee');
      }
    }

    function searchEmployees() {
      const searchValue = document.getElementById('employeeSearch').value.toLowerCase();
      const rows = document.querySelectorAll('#employeeTableBody tr');

      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchValue) ? '' : 'none';
      });
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    }
  </script>
  <script src="/js/global.js"></script>
</body>
</html>
